name: Telegram Notification

on:
  push:
    branches:
      - master
    paths:
      - "client/**"
      - "scripts/**"
      - "package.json"
      - "bun.lock"
      - ".github/workflows/**"
      - "!**/*.md"

jobs:
  build:
    name: Build Android App
    uses: ./.github/workflows/client.yml
    secrets: inherit

  send_telegram_notification:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: üì• Download APK from S3
        run: aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/ci-artifacts/${{ needs.build.outputs.run_id }}/${{ needs.build.outputs.apk_filename }} .

      - name: üîç Find APK filename
        id: find_apk
        run: |
          apk_file=$(find . -name "*.apk" -type f | head -n 1 | xargs basename)
          echo "apk_filename=${apk_file}" >> $GITHUB_OUTPUT
        shell: bash

      - name: üöÄ Start local Telegram Bot API server
        run: |
          docker run -d --name local-bot-api \
            -p 8081:8081 \
            -v ${{ github.workspace }}:/data \
            -e TELEGRAM_API_ID=${{ secrets.TELEGRAM_API_ID }} \
            -e TELEGRAM_API_HASH=${{ secrets.TELEGRAM_API_HASH }} \
            aiogram/telegram-bot-api:latest --local

      - name: ‚è≥ Wait for Bot API server to be ready
        run: |
          echo "Waiting 5 seconds for the local Bot API server to initialize..."
          sleep 5

      - name: üì§ Send APK using local Bot API server
        run: |
          curl -s -X POST "http://localhost:8081/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument" \
          -F chat_id="${{ secrets.BLIXT_CHAT_ID }}" \
          -F message_thread_id="${{ secrets.BLIXT_TOPIC_ID }}" \
          -F document=@"${{ steps.find_apk.outputs.apk_filename }}" \
          -F caption="ü§ñ New Noah Android build is available!

          üìù Commit: ${{ github.sha }}
          üí¨ Message: ${{ github.event.head_commit.message }}"

      - name: üõë Stop and remove local Bot API server
        if: always()
        run: |
          echo "Stopping and removing the Docker container..."
          docker stop local-bot-api
          docker rm local-bot-api
