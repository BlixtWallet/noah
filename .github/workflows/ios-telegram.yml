name: iOS Telegram Notification

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - "client/**"
      - "scripts/**"
      - ".github/workflows/noah-build-release-ios.yml"
      - ".github/workflows/ios-telegram.yml"
      - "package.json"
      - "bun.lock"

jobs:
  build:
    name: Build iOS Device App
    uses: ./.github/workflows/ios-device-build.yml
    secrets: inherit

  upload_and_notify:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}

      - name: ğŸ“¤ Upload to Diawi
        id: upload_diawi
        run: |
          response=$(curl -s -X POST "https://upload.diawi.com/" \
            -F token="${{ secrets.DIAWI_TOKEN }}" \
            -F file=@"${{ needs.build.outputs.ipa_filename }}")

          echo "Upload response: ${response}"

          job_token=$(echo "$response" | jq -r '.job')

          if [ "$job_token" == "null" ] || [ -z "$job_token" ]; then
            echo "Failed to get job token from Diawi"
            echo "$response" | jq .
            exit 1
          fi

          echo "job_token=${job_token}" >> $GITHUB_OUTPUT
          echo "Upload started with job token: ${job_token}"

      - name: â³ Poll Diawi for completion
        id: poll_diawi
        run: |
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            echo "Polling attempt $((attempt + 1))/${max_attempts}..."

            response=$(curl -s "https://upload.diawi.com/status?token=${{ secrets.DIAWI_TOKEN }}&job=${{ steps.upload_diawi.outputs.job_token }}")
            status=$(echo "$response" | jq -r '.status')

            echo "Status: ${status}"

            if [ "$status" == "2000" ]; then
              link=$(echo "$response" | jq -r '.link')
              qrcode=$(echo "$response" | jq -r '.qrcode')
              echo "diawi_link=${link}" >> $GITHUB_OUTPUT
              echo "diawi_qrcode=${qrcode}" >> $GITHUB_OUTPUT
              echo "âœ… Upload complete! Link: ${link}"
              exit 0
            elif [ "$status" == "2001" ]; then
              message=$(echo "$response" | jq -r '.message // "Processing..."')
              echo "â³ ${message}"
              sleep 2
              attempt=$((attempt + 1))
            else
              error=$(echo "$response" | jq -r '.message // "Unknown error"')
              echo "âŒ Upload failed with status ${status}: ${error}"
              echo "$response" | jq .
              exit 1
            fi
          done

          echo "â±ï¸ Timeout waiting for upload to complete after $((max_attempts * 2)) seconds"
          exit 1

      - name: ğŸ“¢ Send to Telegram
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -F chat_id="${{ secrets.BLIXT_CHAT_ID }}" \
            -F message_thread_id="${{ secrets.BLIXT_TOPIC_ID }}" \
            -F text="ğŸ New Noah iOS build is available!

          ğŸ“¥ Download: ${{ steps.poll_diawi.outputs.diawi_link }}

          ğŸ“ Commit: ${{ github.sha }}
          ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
