name: CI

on:
  pull_request:
    paths:
      - "client/**"
      - "scripts/**"
      - "package.json"
      - "bun.lock"
      - "!**/*.md"
      - "!**/.github/workflows/*"
  workflow_call:
    inputs:
      build_aab:
        description: "Whether to build AAB in addition to APK"
        required: false
        type: boolean
        default: false
    outputs:
      artifact_name:
        description: "The name of the uploaded artifact"
        value: ${{ jobs.android_build.outputs.artifact_name }}
      apk_filename:
        description: "The filename of the APK"
        value: ${{ jobs.android_build.outputs.apk_filename }}
      aab_filename:
        description: "The filename of the AAB"
        value: ${{ jobs.android_build.outputs.aab_filename }}
      run_id:
        description: "The run ID for S3 artifact path"
        value: ${{ jobs.android_build.outputs.run_id }}

jobs:
  lint:
    runs-on: self-hosted
    steps:
      - name: ğŸ— Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install signet app dependencies
        run: nix develop .# --command bash -c "bun install --frozen-lockfile"

      - name: âœ¨ Lint code
        run: nix develop .# --command bash -c "bun client lint"

      - name: ğŸ” Typecheck code
        run: nix develop .# --command bash -c "bun client typecheck"

  podfile_lock_check:
    runs-on: macOS
    steps:
      - name: ğŸ— Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install signet app dependencies
        run: nix develop .# --command bash -c "bun install --frozen-lockfile"

      - name: ğŸ§© Install pods (deployment)
        run: nix develop .# --command bash -c "cd client/ios && pod install --deployment"

      - name: ğŸ”’ Ensure Podfile.lock is committed
        run: git diff --exit-code -- client/ios/Podfile.lock

  android_build:
    runs-on: self-hosted
    needs: lint
    outputs:
      artifact_name: ${{ steps.rename_apk.outputs.artifact_name }}
      apk_filename: ${{ steps.rename_apk.outputs.apk_filename }}
      aab_filename: ${{ steps.aab_meta.outputs.aab_filename }}
      run_id: ${{ github.run_id }}
    steps:
      - name: ğŸ— Checkout code
        uses: actions/checkout@v4

      # - name: Install Nix
      #   uses: DeterminateSystems/nix-installer-action@main

      # - name: Enable Nix Magic Cache
      #   uses: DeterminateSystems/magic-nix-cache-action@main

      - name: ğŸ“¦ Install signet app dependencies
        run: nix develop .# --command bash -c "bun install --frozen-lockfile"

      - name: ğŸ”§ Create sentry.properties
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: ./scripts/create_sentry_properties.sh

      - name: ğŸ” Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > client/android/app/release.keystore

      - name: ğŸ”§ Create local.properties for release signing
        env:
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./scripts/create_local_properties.sh

      - name: ğŸ”¨ Build signet Android app (APK)
        run: nix develop .# --command bash -c "bun client build:android:ci"

      - name: ğŸ“¦ Build signet Android app (AAB)
        if: ${{ inputs.build_aab }}
        run: nix develop .# --command bash -c "cd client/android && ./gradlew bundleSignetRelease -PreactNativeArchitectures=arm64-v8a"

      - name: ğŸ§¹ Clean up keystore & local.properties
        if: ${{ always() }}
        run: |
          rm -f client/android/app/release.keystore
          rm -f client/android/local.properties

      - name: ğŸ“ Rename APK with timestamp
        id: rename_apk
        run: |
          apk_path="client/android/app/build/outputs/apk/signet/release/app-signet-release.apk"
          timestamp=$(date +'%Y-%m-%d-%H-%M')
          new_apk_name="noah-android-apk-${timestamp}"
          apk_filename="${new_apk_name}.apk"
          new_apk_path="client/android/app/build/outputs/apk/signet/release/${apk_filename}"
          mv "${apk_path}" "${new_apk_path}"
          echo "new_path=${new_apk_path}" >> $GITHUB_OUTPUT
          echo "artifact_name=${new_apk_name}" >> $GITHUB_OUTPUT
          echo "apk_filename=${apk_filename}" >> $GITHUB_OUTPUT
        shell: bash

      - name: ğŸ“ Prepare AAB outputs
        id: aab_meta
        # Always run so job outputs are defined whether or not we built an AAB
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          aab_expected="client/android/app/build/outputs/bundle/signetRelease/app-signet-release.aab"
          if [[ "${{ inputs.build_aab }}" == 'true' && -f "$aab_expected" ]]; then
            timestamp=$(date +'%Y-%m-%d-%H-%M')
            aab_filename="noah-android-aab-${timestamp}.aab"
            new_aab_path="client/android/app/build/outputs/bundle/signetRelease/${aab_filename}"
            mv "$aab_expected" "$new_aab_path"
            echo "new_path=${new_aab_path}" >> "$GITHUB_OUTPUT"
            echo "aab_filename=${aab_filename}" >> "$GITHUB_OUTPUT"
          else
            echo "new_path=" >> "$GITHUB_OUTPUT"
            echo "aab_filename=" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: ğŸ“¤ Upload Android APK to S3
        run: aws s3 cp ${{ steps.rename_apk.outputs.new_path }} s3://${{ secrets.AWS_S3_BUCKET }}/ci-artifacts/${{ github.run_id }}/${{ steps.rename_apk.outputs.apk_filename }}

      - name: ğŸ“¤ Upload Android AAB to S3
        if: ${{ inputs.build_aab && steps.aab_meta.outputs.new_path != '' }}
        run: aws s3 cp ${{ steps.aab_meta.outputs.new_path }} s3://${{ secrets.AWS_S3_BUCKET }}/ci-artifacts/${{ github.run_id }}/${{ steps.aab_meta.outputs.aab_filename }}

  client_gate:
    runs-on: ubuntu-latest
    needs: [lint, podfile_lock_check, android_build]
    if: always()
    steps:
      - name: âœ… Gate
        run: |
          if [[ "${{ needs.lint.result }}" == "success" || "${{ needs.lint.result }}" == "skipped" ]] && \
             [[ "${{ needs.podfile_lock_check.result }}" == "success" || "${{ needs.podfile_lock_check.result }}" == "skipped" ]] && \
             [[ "${{ needs.android_build.result }}" == "success" || "${{ needs.android_build.result }}" == "skipped" ]]; then
            echo "Client checks passed or skipped"
            exit 0
          else
            echo "Client checks failed"
            exit 1
          fi
